<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets">
<h:head>
    <title>Проверка точки</title>
    <h:outputStylesheet name="css/style.css"/>
</h:head>
<h:body>
    <div id="container">
        <div class="top-bar">
            <h:link value="Вернуться на стартовую" outcome="index" styleClass="back-link"/>
        </div>

        <div class="content-wrapper">
            <!-- Левая колонка: Форма -->
            <div class="form-panel">
                <h:form id="mainForm">
                    <h3>Координаты точки</h3>

                    <!-- X: Command Buttons -->
                    <div class="input-group">
                        <label>Выберите X:</label>
                        <div class="x-buttons-container">
                            <!-- Создаем кнопки через ui:repeat или вручную -->
                            <ui:repeat value="#{pointBean.XOptions}" var="xVal">
                                <h:commandButton value="#{xVal}" styleClass="x-btn #{pointBean.x eq xVal ? 'selected' : ''}">
                                    <f:ajax listener="#{pointBean.setX(xVal)}" render="@form" />
                                </h:commandButton>
                            </ui:repeat>
                        </div>
                        <div style="margin-top: 5px; font-size: 0.9em;">
                            Выбрано X: <b><h:outputText value="#{pointBean.x}" /></b>
                        </div>
                    </div>

                    <!-- Y: Input Text -->
                    <div class="input-group">
                        <label>Введите Y (-3 ... 5):</label><br/>
                        <h:inputText id="yInput" value="#{pointBean.y}" required="true"
                                     converterMessage="Y должен быть числом"
                                     validatorMessage="Y должен быть от -3 до 5">
                            <f:validateDoubleRange minimum="-3.0" maximum="5.0" />
                            <f:ajax event="keyup" render="yError" />
                        </h:inputText>
                        <h:message for="yInput" id="yError" style="color: red; font-size: 0.8em; display: block"/>
                    </div>

                    <!-- R: SelectOneRadio -->
                    <div class="input-group">
                        <label>Выберите R:</label>
                        <h:selectOneRadio value="#{pointBean.r}" layout="pageDirection">
                            <f:selectItem itemValue="1.0" itemLabel="1" />
                            <f:selectItem itemValue="2.0" itemLabel="2" />
                            <f:selectItem itemValue="3.0" itemLabel="3" />
                            <f:selectItem itemValue="4.0" itemLabel="4" />
                            <f:selectItem itemValue="5.0" itemLabel="5" />
                            <f:ajax render="graphPanel" onevent="redrawGraph" />
                        </h:selectOneRadio>
                    </div>

                    <h:commandButton value="Проверить" action="#{pointBean.checkPoint}" styleClass="submit-btn">
                        <!-- После проверки обновляем таблицу и скрипт отрисовки точек -->
                        <f:ajax execute="@form" render="resultsTable graphPanel" onevent="redrawGraph"/>
                    </h:commandButton>
                </h:form>
            </div>

            <!-- Правая колонка: График -->
            <div class="graph-panel">
                <h:panelGroup id="graphPanel">
                    <div id="chart-container">
                        <!-- Сюда JS вставит SVG -->
                    </div>

                    <!-- Скрытая форма для кликов по графику -->
                    <h:form id="hiddenForm" style="display:none;">
                        <h:inputHidden id="graphX" value="#{pointBean.graphX}" />
                        <h:inputHidden id="graphY" value="#{pointBean.graphY}" />
                        <h:inputHidden id="graphR" value="#{pointBean.r}" />
                        <h:commandButton id="graphSubmit" action="#{pointBean.checkGraphPoint}">
                            <f:ajax execute="@form" render=":resultsTable :graphPanel" onevent="redrawGraph"/>
                        </h:commandButton>
                    </h:form>

                    <!-- Передача данных в JS -->
                    <script>
                        var currentR = #{pointBean.r};
                        var pointsHistory = [
                            <ui:repeat value="#{pointBean.results}" var="res" varStatus="status">
                                {x: #{res.x}, y: #{res.y}, r: #{res.r}, hit: #{res.hit}}#{status.last ? '' : ','}
                            </ui:repeat>
                        ];
                    </script>
                </h:panelGroup>
            </div>
        </div>

        <!-- Таблица результатов -->
        <div class="table-panel">
            <h:dataTable value="#{pointBean.results}" var="res" id="resultsTable"
                         styleClass="results-table" headerClass="table-header" rowClasses="table-row">
                <h:column>
                    <f:facet name="header">X</f:facet>
                    #{res.x}
                </h:column>
                <h:column>
                    <f:facet name="header">Y</f:facet>
                    #{res.y}
                </h:column>
                <h:column>
                    <f:facet name="header">R</f:facet>
                    #{res.r}
                </h:column>
                <h:column>
                    <f:facet name="header">Попадание</f:facet>
                    <span class="#{res.hit ? 'hit-yes' : 'hit-no'}">
                        #{res.hit ? 'Да' : 'Нет'}
                    </span>
                </h:column>
                <h:column>
                    <f:facet name="header">Время</f:facet>
                    #{res.curTime}
                </h:column>
                <h:column>
                    <f:facet name="header">Выполнение (мкс)</f:facet>
                    #{res.execTime}
                </h:column>
            </h:dataTable>
        </div>
    </div>

    <h:outputScript name="js/script.js"/>
</h:body>
</html>